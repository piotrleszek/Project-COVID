---
title: "Report COVID19"
author: "Piotr Pawlowicz"
date: "`r Sys.Date()`"
output:
  html_document:
        toc: true
        theme: "readable"

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. R libraries used in this report

In this report following R libraries have been used:

```{r echo=TRUE, warning=FALSE, message=FALSE}
library(openxlsx)
library(ggplot2)
library(dplyr)
library(plotly)
library(corrplot)
library(caret)
library(summarytools)
library(backports)
library(skimr)

```


## 2. Extracting the data

### 2.1. Loading data into RawDataDF dataframe

```{r echo=TRUE, warning=FALSE, message=FALSE}
FileName <- "wuhan_blood_sample_data_Jan_Feb_2020.xlsx"
RawDataDF <- data.frame(openxlsx::read.xlsx(FileName, sheet = "Sheet1", colNames = TRUE, fillMergedCells = TRUE) )
```

### 2.2. The source file has following attributes:

```{r echo=TRUE, warning=FALSE, message=FALSE}
knitr::kable(file.info(FileName))
```

## 3. Cleaning the data

### 3.1. Adjusting date/time columns

```{r echo=TRUE, warning=FALSE, message=FALSE}
ClearedDataDF <- mutate(RawDataDF, RE_DATE = openxlsx::convertToDateTime(RE_DATE), Admission.time=openxlsx::convertToDateTime(Admission.time),Discharge.time = openxlsx::convertToDateTime(Discharge.time))
```

### 3.2. Grouping the data by patient

```{r echo=TRUE, warning=FALSE, message=FALSE}
GroupedByPatientDF <- aggregate(ClearedDataDF[, -c(1, 2, 5, 6)], by = list(ClearedDataDF$PATIENT_ID), FUN = mean, na.rm = TRUE) %>% rename(PATIENT_ID = Group.1) %>% arrange(PATIENT_ID)
GroupedByPatientDF["outcome"][GroupedByPatientDF["outcome"] == 1] <- "died"
GroupedByPatientDF["outcome"][GroupedByPatientDF["outcome"] == 0] <- "survived"

```


### 3.3. Characteristics of input dataset

```{r echo=TRUE, warning=FALSE, message=FALSE}
skim(GroupedByPatientDF)

```



## 4. Correlations

### 4.1. Introduction

Below chapter is a trial of finding correlations between attributes taken out of bloodtests and final outcome (if patient died or survived).

For every further correlation analysis this customized function was applied. Please note the <b>threshold</b> parameter that limits the output to significancy at desired level.

```{r echo=TRUE, warning=FALSE, message=FALSE}
  my_correlation <- function (selected_parameters, reference = "outcome", threshold = 0) {

  df_cor <- GroupedByPatientDF[ , selected_parameters] %>% mutate_if(is.character, as.factor)%>% mutate_if(is.factor, as.numeric)
  corr <- cor(df_cor, use= "pairwise.complete.obs", method = "spearman")
  corr[lower.tri(corr,diag=TRUE)] <- NA
  corr <- as.data.frame(as.table(corr))%>%na.omit(corr)%>%subset(Var1 == reference)
  corr <- subset(corr, abs(Freq) >= threshold)
  corr <- corr[order(-abs(corr$Freq)),]
  mtx_corr <<- reshape2::acast(corr, Var1~Var2, value.var="Freq")
  
  corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ", method = "number", cl.pos = "n", tl.cex = 0.85, number.cex = 0.8)
  
  }
```

### 4.2. Most significant attributes

In order to distinguish attributes that may have the biggest impact on outcome a threshold level of <b>0.65</b> has been applied.

```{r echo=TRUE, warning=FALSE, message=FALSE}

  my_correlation(selected_parameters = 1:78, threshold = 0.65)

  table <- as.data.frame(t(mtx_corr)) %>% arrange(outcome)
  knitr::kable(table)
  
  
```

### 4.3. Specific parameters

According to the <a href = "https://www.nature.com/articles/s42256-020-0180-7">article</a> there are three parameters that show signigficant correlation with the outcome. The further analysis is going to focus on them:

<ul>
<li>Lactate.dehydrogenase</li>
<li>lymphocyte.count</li>
<li>High.sensitivity.C.reactive.protein</li>
</ul>

### 4.4. Analysis of the 3 parameters

```{r echo=TRUE, warning=FALSE, message=FALSE}
selected_parameters <- c("Lactate.dehydrogenase", "lymphocyte.count", "High.sensitivity.C.reactive.protein")
knitr::kable(summary(GroupedByPatientDF[ , selected_parameters]))
```


### 4.5. Correlation between the 3 parameters and outcome. What about age?

Below analysis shows the correlations between the 3 parameters and <b>likelihood of survival</b>.
What is interesting, age itself does not show very strong correlation with outcome (since outbreak of COVID19 higher age has always been treated as a potential threat for patient). Below chart shows also the dominant number of patients between 60-70 in comparison to other age groups:

```{r echo=TRUE, warning=FALSE, message=FALSE}

ggplot(data=GroupedByPatientDF, aes(age)) + 
  geom_histogram(bins = 10)

```


```{r echo=TRUE, warning=FALSE, message=FALSE}

  selected_parameters <- c("outcome", "Lactate.dehydrogenase", "lymphocyte.count", "High.sensitivity.C.reactive.protein", "age")
  my_correlation(selected_parameters)
  knitr::kable(mtx_corr)

```

### 4.6. In-depth analysis of the 3 parameters and age

```{r echo=TRUE, warning=FALSE, message=FALSE}

legend_colors <- c("died" = "#000000","survived" = "#119826")

ggplotly(
ggplot(GroupedByPatientDF, aes(x=age, y=Lactate.dehydrogenase ,col =outcome)) + geom_point() + scale_color_manual(values =  legend_colors) + ggtitle("Lactate.dehydrogenase vs age")
)

```

The higher the level of Lactate.dehydrogenase, the higher the probability of death, majority of occurencies happened to older patients.

```{r echo=TRUE, warning=FALSE, message=FALSE}
ggplotly(
ggplot(GroupedByPatientDF, aes(x=age, y=lymphocyte.count ,col =outcome)) + geom_point() + scale_color_manual(values =  legend_colors) + ylim (0, 5) + ggtitle("lymphocyte.count vs age")
)
```

The lower the level of lymphocyte.count, the higher the probability of death, majority of occurencies happened to older patients.


```{r echo=TRUE, warning=FALSE, message=FALSE}
ggplotly(
ggplot(GroupedByPatientDF, aes(x=age, y=High.sensitivity.C.reactive.protein ,col =outcome)) + geom_point() + scale_color_manual(values =  legend_colors) + ggtitle("High.sensitivity.C.reactive.protein vs age")
)

```

The higher the level of High.sensitivity.C.reactive.protein, the higher the probability of death, majority of occurencies happened to older patients.

## 5. Classification model

### 5.1. Preparing dataset

```{r echo=TRUE, warning=FALSE, message=FALSE}

selected_parameters <- c("outcome", "Lactate.dehydrogenase", "lymphocyte.count", "High.sensitivity.C.reactive.protein")

ClassificationDF <- GroupedByPatientDF[ , c(selected_parameters)]

ClassificationDF <- ClassificationDF %>% filter(!is.nan(Lactate.dehydrogenase))
ClassificationDF <- ClassificationDF %>% filter(!is.nan(lymphocyte.count))
ClassificationDF <- ClassificationDF %>% filter(!is.nan(High.sensitivity.C.reactive.protein))

```

### 5.2. Dividing dataset

```{r echo=TRUE, warning=FALSE, message=FALSE}

set.seed(23)
inTraining <- createDataPartition(
y = ClassificationDF$outcome,
p = .75,
list = FALSE)

training <- ClassificationDF[ inTraining,]
testing  <- ClassificationDF[-inTraining,]
```

### 5.3. Schema

```{r echo=TRUE, warning=FALSE, message=FALSE}

ctrl <- trainControl(
method = "repeatedcv",
number = 2,
repeats = 5)
```

### 5.4. Learning

```{r echo=TRUE, warning=FALSE, message=FALSE}

fit <- train(outcome ~ .,
data = training,
method = "rf",
trControl = ctrl,
ntree = 10)

fit
```

### 5.5. Prediction and parameter optimization

```{r echo=TRUE, warning=FALSE, message=FALSE}

rfClasses <- predict(fit, newdata = testing)
confusionMatrix(table(rfClasses, testing$outcome))

rfGrid <- expand.grid(mtry = 10:30)
gridCtrl <- trainControl(
method = "repeatedcv",
summaryFunction = twoClassSummary,
classProbs = TRUE,
number = 2,
repeats = 5)

set.seed(23)
fitTune <- train(outcome ~ .,
data = training,
method = "rf",
metric = "ROC",
preProc = c("center", "scale"),
trControl = gridCtrl,
tuneGrid = rfGrid,
ntree = 30)

fitTune

ggplot(fitTune) + theme_bw()

```


